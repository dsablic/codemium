# AI Code Estimation Design

## Overview

Add a `--ai-estimate` flag to the `analyze` command that estimates the percentage of AI-written code in each repository by scanning git commit history via provider APIs for AI attribution signals.

## Approach

**Commit List API (REST)** — Fetch commit history from GitHub/Bitbucket APIs, detect AI signals in commit metadata, then fetch per-commit stats (additions/deletions) only for flagged commits. No extra cloning needed beyond the existing shallow clone for code analysis.

## Data Model

New types in `internal/model/model.go`:

```go
type AISignal string

const (
    SignalCoAuthor      AISignal = "co-author"
    SignalCommitMessage AISignal = "commit-message"
    SignalBotAuthor     AISignal = "bot-author"
)

type AICommit struct {
    Hash      string     `json:"hash"`
    Author    string     `json:"author"`
    Message   string     `json:"message"`
    Signals   []AISignal `json:"signals"`
    Additions int64      `json:"additions"`
    Deletions int64      `json:"deletions"`
}

type AIEstimate struct {
    TotalCommits    int64      `json:"total_commits"`
    AICommits       int64      `json:"ai_commits"`
    CommitPercent   float64    `json:"commit_percent"`
    TotalAdditions  int64      `json:"total_additions"`
    AIAdditions     int64      `json:"ai_additions"`
    AdditionPercent float64    `json:"addition_percent"`
    Details         []AICommit `json:"details,omitempty"`
}
```

Existing types get new optional fields:

- `RepoStats.AIEstimate *AIEstimate` (`json:"ai_estimate,omitempty"`)
- `Report.AIEstimate *AIEstimate` (`json:"ai_estimate,omitempty"`)

## Provider Interface Extension

Two new methods on `provider.Provider`:

```go
type CommitInfo struct {
    Hash      string
    Author    string
    Message   string
    Additions int64
    Deletions int64
}

ListCommits(ctx context.Context, repo model.Repo) ([]CommitInfo, error)
CommitStats(ctx context.Context, repo model.Repo, hash string) (additions, deletions int64, err error)
```

**GitHub:**
- `GET /repos/{owner}/{repo}/commits` (paginated list)
- `GET /repos/{owner}/{repo}/commits/{sha}` (stats for flagged commits)

**Bitbucket:**
- `GET /repositories/{workspace}/{slug}/commits` (paginated list)
- `GET /repositories/{workspace}/{slug}/diffstat/{sha}` (stats for flagged commits)

**Optimization:** `ListCommits` returns commits without stats. `CommitStats` is called only for AI-flagged commits.

## AI Signal Detection

New package `internal/aidetect/detect.go`:

```go
func Detect(author, message string) []AISignal
```

Three signal types:

1. **Co-author trailers** — Parse `Co-Authored-By:` lines (case-insensitive), match against known AI tool names: Claude, Copilot, Cursor, Codeium, Gemini, ChatGPT, OpenAI, Anthropic, Windsurf, Aider, Amazon Q. Also match `[bot]` email patterns.

2. **Commit message patterns** — Case-insensitive match for: `generated by`, `ai-generated`, `ai-assisted`, `auto-generated`, plus tool-specific markers.

3. **Bot author matching** — Author name ends with `[bot]`, email matches `*[bot]@users.noreply.github.com`, known bot names (dependabot, renovate, github-actions, copilot).

Known patterns stored as package-level variables for easy extension.

## Integration into `analyze` Command

**CLI flags:**
- `--ai-estimate` (bool, default false)
- `--ai-commit-limit N` (int, default 500) — max recent commits to scan per repo. 0 = unlimited.

**Flow:**
1. Standard analysis runs as today (shallow clone, scc)
2. Second pass for AI estimation using the worker pool (same `--concurrency`):
   - `ListCommits` per repo (up to `--ai-commit-limit`)
   - `Detect` on each commit's author + message
   - `CommitStats` for flagged commits only
   - Build `AIEstimate` per repo
3. Aggregate `AIEstimate` across all repos
4. Attach to `RepoStats` and `Report`

**Progress UI:** Second phase with "Estimating AI contribution..." label, repo-level progress.

**Error handling:** Same partial-failure model. Rate limit errors: respect `Retry-After` / `X-RateLimit-Reset` headers, log warnings.

## Output Formats

**JSON:** No changes needed — `omitempty` handles presence/absence.

**Markdown:** New sections when AI estimate data is present:

Aggregate table after Summary:

```markdown
## AI Code Estimation

| Metric | Total | AI-Attributed | Percentage |
|--------|-------|---------------|------------|
| Commits | 1,234 | 312 | 25.3% |
| Line additions | 45,678 | 12,345 | 27.0% |
```

Per-repo: Two new columns appended to the Repositories table (`AI Commits %`, `AI Additions %`).

**Narrative:** No changes needed — AI estimate data in JSON is consumed by the AI CLI naturally.

## Rate Limiting

- Max page size per API call (100 items)
- `--ai-commit-limit` (default 500) bounds scan depth per repo
- Detail calls only for flagged commits (~10% typical)
- Check `X-RateLimit-Remaining`, sleep until reset when low
- Worker pool concurrency already bounds parallel API calls

**Estimated cost** (100 repos, 500 commits, 10% AI): ~2,700 API calls with defaults.
